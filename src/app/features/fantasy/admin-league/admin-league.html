<!-- TOGGLE DE LIGAS -->
<div class="admin-container" *ngIf="!loading">

    <h2 class="title">Ligas</h2>

    <!-- Cambiar liga -->
    <div class="view-toggle league-toggle" *ngIf="adminLeagues.length > 1">
        <button *ngFor="let lg of adminLeagues; index as i" class="league-btn gral-button"
            [class.active]="selectedLeagueIndex === i" (click)="attemptLeagueChange(i)">
            {{ lg.league.name }}
        </button>
    </div>

    <p class="error" *ngIf="errorMsg">{{ errorMsg }}</p>
    <p class="success" *ngIf="successMsg">{{ successMsg }}</p>

    <!-- ============================
          SECCIÓN INFO LIGA
    ============================= -->
    <div class="league-box">
        <div class="league-header">
            <h3 class="league-name">{{ league?.name }}</h3>
            <p class="league-id">ID: {{ league?.id }}</p>
        </div>

        <div class="privacy-row">
            <label class="privacy-title">Privacidad:</label>

            <label class="switch">
                <input type="checkbox" [(ngModel)]="isPrivate" (change)="onFieldChanged()">
                <span class="slider"></span>
            </label>

            <span class="privacy-label" [class.private]="isPrivate" [class.public]="!isPrivate">
                {{ isPrivate ? 'Privada' : 'Pública' }}
            </span>
        </div>
    </div>

    <!-- ============================
      ELIMINAR LIGA
============================= -->
    <div class="delete-league-box" *ngIf="isCreator()">
        <button class="delete-league-btn" (click)="openDeleteLeagueModal()">
            Eliminar Liga
        </button>
    </div>

    <!-- ============================
            MIEMBROS
    ============================= -->
    <div class="members-section">
        <h3>Miembros ({{ members.length }})</h3>

        <div class="empty" *ngIf="members.length === 0">
            Todavía no hay miembros en esta liga.
        </div>

        <div class="user-grid">

            <div class="user-card" *ngFor="let u of members" [class.appearing]="u._new"
                [class.admin]="u.role === 'admin'" [class.to-delete]="u._delete" [class.to-inactivate]="u._inactivate"
                [class.to-promote]="u._promote" [class.to-demote]="u._demote">

                <div class="user-info">
                    <span class="user-name">{{ u.username }}</span>

                    <!-- BADGES -->
                    <div class="user-badges">

                        <!-- Rol admin -->
                        <span class="admin-badge" *ngIf="u.role === 'admin'">ADMIN</span>

                        <!-- Estados -->
                        <span class="status-badge active" *ngIf="u.status === 'active'">
                            Activo
                        </span>

                        <span class="status-badge inactive" *ngIf="u.status === 'inactive'">
                            Inactivo
                        </span>

                        <span class="status-badge pending" *ngIf="u.status === 'pending'">
                            Pendiente
                        </span>

                        <span class="status-badge rejected" *ngIf="u.status === 'rejected'">
                            Rechazada
                        </span>
                    </div>

                    <span class="user-email">{{ u.email }}</span>
                </div>

                <!-- ACCIONES -->
                <div class="user-actions">

                    <!-- ========================= -->
                    <!-- INVITACIONES PENDIENTES  -->
                    <!-- ========================= -->
                    <button class="icon-btn remove" *ngIf="u.origin === 'invite' && u.status === 'pending'"
                        (click)="cancelInvite(u)">
                        <svg viewBox="0 0 24 24">
                            <path d="M18 6L6 18M6 6l12 12" stroke-width="2" stroke-linecap="round" />
                        </svg>
                    </button>


                    <!-- ========================= -->
                    <!-- USUARIOS DE TEAM (RELES) -->
                    <!-- ========================= -->

                    <!-- INACTIVAR USUARIO -->
                    <button class="icon-btn inactivate"
                        *ngIf="u.origin === 'team' && u.status === 'active' && u.id !== league.created_by"
                        (click)="openRemoveModal(u, 'inactivate'); markDirty()">

                        <svg viewBox="0 0 24 24">
                            <path d="M4 12h16" stroke-width="2" stroke-linecap="round" />
                        </svg>

                    </button>


                    <!-- ACTIVAR -->
                    <button class="icon-btn activate" *ngIf="u.origin === 'team' && u.status === 'inactive'"
                        (click)="activateUser(u); markDirty()">
                        <svg viewBox="0 0 24 24">
                            <path d="M5 13l4 4L19 7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </button>

                    <!-- PROMOVER ADMIN -->
                    <button class="icon-btn promote"
                        *ngIf="u.origin === 'team' && u.status === 'active' && u.role !== 'admin'"
                        (click)="makeAdmin(u); markDirty()">
                        <svg viewBox="0 0 24 24">
                            <path d="M3 7l4 2 5-6 5 6 4-2-2 12H5L3 7z" />
                        </svg>
                    </button>

                    <!-- QUITAR ADMIN (excepto creador) -->
                    <button class="icon-btn demote"
                        *ngIf="u.origin === 'team' && u.status === 'active' && u.role === 'admin' && u.id !== league.created_by"
                        (click)="removeAdmin(u); markDirty()">
                        <svg viewBox="0 0 24 24">
                            <path d="M12 5v14m0 0l-6-6m6 6l6-6" stroke-width="2" stroke-linecap="round" />
                        </svg>
                    </button>

                    <!-- ELIMINAR USUARIO REAL -->
                    <button class="icon-btn remove" *ngIf="u.origin === 'team' && u.id !== league.created_by"
                        (click)="onRemoveClicked(u)">
                        <svg viewBox="0 0 24 24">
                            <path d="M18 6L6 18M6 6l12 12" stroke-width="2" stroke-linecap="round" />
                        </svg>
                    </button>

                </div>


            </div>

        </div>
    </div>

    <!-- ============================
          AGREGAR USUARIO
    ============================= -->
    <div class="invite-box">
        <h3>Invitar Usuarios</h3>

        <select class="fancy-select" [ngModel]="selectedUser" (ngModelChange)="onUserChanged($event)">

            <option [ngValue]="null">Seleccionar usuario</option>

            <option *ngFor="let u of allUsers; trackBy: trackById" [ngValue]="u" [disabled]="isAlreadyMember(u)">
                {{ u.username }}
            </option>

        </select>

    </div>

    <!-- GUARDAR -->
    <button class="save-btn" (click)="saveChanges()" [disabled]="saving">

        <ng-container *ngIf="saving; else normalBtn">
            {{ successMsg || 'Guardando...' }}
        </ng-container>

        <ng-template #normalBtn>
            Guardar cambios
        </ng-template>

    </button>

</div>

<!-- ============================
            MODAL ELIMINAR
============================= -->
<div class="modal-backdrop" *ngIf="modalUser">
    <div class="modal-box">

        <h3>
            {{ removeMode === 'delete' ? 'Eliminar usuario' : 'Inactivar usuario' }}
        </h3>

        <p>
            {{ removeMode === 'delete'
            ? '¿Seguro que querés eliminar a'
            : '¿Querés marcar como inactivo a' }}
            <strong>{{ modalUser.username }}</strong>?
        </p>

        <div class="modal-buttons">
            <button class="cancel-btn" (click)="modalUser = null">Cancelar</button>

            <button class="confirm-btn" (click)="confirmRemove()">
                {{ removeMode === 'delete' ? 'Eliminar' : 'Inactivar' }}
            </button>
        </div>
    </div>
</div>

<!-- ============================
     MODAL CAMBIOS SIN GUARDAR
============================= -->
<div class="modal-backdrop" *ngIf="showUnsavedModal">
    <div class="modal-box unsaved-modal">

        <h3 class="modal-title">Cambios sin guardar</h3>

        <p class="modal-message">
            Tenés cambios sin guardar.<br>
            ¿Querés salir igual?
        </p>

        <div class="modal-buttons">
            <button class="cancel-btn" (click)="cancelUnsavedExit()">Cancelar</button>

            <button class="confirm-btn danger" (click)="confirmUnsavedExit()">
                Salir sin guardar
            </button>
        </div>

    </div>
</div>

<!-- ======================================= -->
<!-- MODAL ELIMINAR LIGA -->
<!-- ======================================= -->
<div class="modal-backdrop" *ngIf="showDeleteLeagueModal">
    <div class="modal-box">

        <h3>Eliminar liga</h3>
        <p>¿Seguro que querés eliminar <strong>{{ league?.name }}</strong>?
            Esta acción <b>no se puede deshacer</b> y se borrará toda la información relacionada.</p>

        <div class="modal-buttons">
            <button class="cancel-btn" (click)="cancelDeleteLeague()">Cancelar</button>
            <button class="confirm-btn" (click)="confirmDeleteLeague()">Eliminar</button>
        </div>

    </div>
</div>