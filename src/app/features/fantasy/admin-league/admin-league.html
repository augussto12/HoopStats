<!-- TOGGLE DE LIGAS -->
<div class="admin-container" *ngIf="!loading">

    <h2 class="title">Ligas</h2>

    <!-- Cambiar liga -->
    <div class="view-toggle league-toggle" *ngIf="adminLeagues.length > 1">
        <button *ngFor="let lg of adminLeagues; index as i" class="league-btn gral-button"
            [class.active]="selectedLeagueIndex === i" (click)="attemptLeagueChange(i)">
            {{ lg.league.name }}
        </button>
    </div>

    <p class="error" *ngIf="errorMsg">{{ errorMsg }}</p>
    <p class="success" *ngIf="successMsg">{{ successMsg }}</p>

    <!-- ============================
          SECCIÃ“N INFO LIGA
    ============================= -->
    <div class="league-box">
        <div class="league-header">
            <h3 class="league-name">{{ league?.name }}</h3>
            <p class="league-id">ID: {{ league?.id }}</p>
        </div>

        <div class="privacy-row">
            <label class="privacy-title">Privacidad:</label>

            <label class="switch">
                <input type="checkbox" [(ngModel)]="isPrivate" (change)="onFieldChanged()">
                <span class="slider"></span>
            </label>

            <span class="privacy-label" [class.private]="isPrivate" [class.public]="!isPrivate">
                {{ isPrivate ? 'Privada' : 'PÃºblica' }}
            </span>
        </div>
    </div>

    <!-- ============================
            MIEMBROS
    ============================= -->
    <div class="members-section">
        <h3>Miembros ({{ members.length }})</h3>

        <div class="empty" *ngIf="members.length === 0">
            TodavÃ­a no hay miembros en esta liga.
        </div>

        <div class="user-grid">

            <div class="user-card" *ngFor="let u of members" [class.appearing]="u._new"
                [class.admin]="u.role === 'admin'" [class.to-delete]="u._delete" [class.to-inactivate]="u._inactivate"
                [class.to-promote]="u._promote" [class.to-demote]="u._demote">

                <div class="user-info">
                    <span class="user-name">{{ u.username }}</span>

                    <!-- BADGES -->
                    <div class="user-badges">

                        <!-- Rol admin -->
                        <span class="admin-badge" *ngIf="u.role === 'admin'">ADMIN</span>

                        <!-- Estados -->
                        <span class="status-badge active" *ngIf="u.status === 'active'">
                            Activo
                        </span>

                        <span class="status-badge inactive" *ngIf="u.status === 'inactive'">
                            Inactivo
                        </span>

                        <span class="status-badge pending" *ngIf="u.status === 'pending'">
                            Pendiente
                        </span>

                        <span class="status-badge rejected" *ngIf="u.status === 'rejected'">
                            Rechazada
                        </span>
                    </div>

                    <span class="user-email">{{ u.email }}</span>
                </div>

                <!-- ACCIONES -->
                <div class="user-actions">

                    <!-- PROMOVER ADMIN -->
                    <button class="promote-btn" *ngIf="u.role !== 'admin' && u.status === 'active' && !u._delete"
                        (click)="makeAdmin(u); markDirty()">
                        ðŸ‘‘
                    </button>

                    <!-- QUITAR ADMIN -->
                    <button class="demote-btn" *ngIf="u.role === 'admin' && u.id !== league.created_by && !u._delete"
                        (click)="removeAdmin(u); markDirty()">
                        â–¼
                    </button>

                    <!-- INACTIVAR -->
                    <button class="inactivate-btn" *ngIf="u.role !== 'admin' && u.status === 'active' && !u._delete"
                        (click)="openRemoveModal(u, 'inactivate'); markDirty()">
                        ðŸš«
                    </button>

                    <!-- ELIMINAR -->
                    <button class="remove-btn" *ngIf="u.role !== 'admin' && !u._delete"
                        (click)="openRemoveModal(u, 'delete'); markDirty()">
                        ðŸ—‘
                    </button>

                </div>
            </div>

        </div>
    </div>

    <!-- ============================
          AGREGAR USUARIO
    ============================= -->
    <div class="invite-box">
        <h3>Invitar Usuarios</h3>

        <select class="fancy-select" [(ngModel)]="selectedUser" (change)="addUser(); markDirty()">

            <option [ngValue]="null">Seleccionar usuario</option>

            <option *ngFor="let u of allUsers" [ngValue]="u" [disabled]="isAlreadyMember(u)">
                {{ u.username }}
            </option>

        </select>
    </div>

    <!-- GUARDAR -->
    <button class="save-btn" (click)="saveChanges()" [disabled]="saving">

        <ng-container *ngIf="saving; else normalBtn">
            {{ successMsg || 'Guardando...' }}
        </ng-container>

        <ng-template #normalBtn>
            Guardar cambios
        </ng-template>

    </button>

</div>

<!-- ============================
            MODAL ELIMINAR
============================= -->
<div class="modal-backdrop" *ngIf="modalUser">
    <div class="modal-box">

        <h3>
            {{ removeMode === 'delete' ? 'Eliminar usuario' : 'Inactivar usuario' }}
        </h3>

        <p>
            {{ removeMode === 'delete'
            ? 'Â¿Seguro que querÃ©s eliminar a'
            : 'Â¿QuerÃ©s marcar como inactivo a' }}
            <strong>{{ modalUser.username }}</strong>?
        </p>

        <div class="modal-buttons">
            <button class="cancel-btn" (click)="modalUser = null">Cancelar</button>

            <button class="confirm-btn" (click)="confirmRemove()">
                {{ removeMode === 'delete' ? 'Eliminar' : 'Inactivar' }}
            </button>
        </div>
    </div>
</div>

<!-- ============================
     MODAL CAMBIOS SIN GUARDAR
============================= -->
<div class="modal-backdrop" *ngIf="showUnsavedModal">
  <div class="modal-box unsaved-modal">

      <h3 class="modal-title">Cambios sin guardar</h3>

      <p class="modal-message">
          TenÃ©s cambios sin guardar.<br>
          Â¿QuerÃ©s salir igual?
      </p>

      <div class="modal-buttons">
          <button class="cancel-btn" (click)="cancelUnsavedExit()">Cancelar</button>

          <button class="confirm-btn danger" (click)="confirmUnsavedExit()">
              Salir igual
          </button>
      </div>

  </div>
</div>
